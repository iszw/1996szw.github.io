<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Vue深入理解 | iSzw_Blog</title><meta name="description" content="Vue深入理解"><meta name="keywords" content="vue,响应式,mvvm,vdom,diff"><meta name="author" content="suvan"><meta name="copyright" content="suvan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Vue深入理解"><meta name="twitter:description" content="Vue深入理解"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fwLR6I.png"><meta property="og:type" content="article"><meta property="og:title" content="Vue深入理解"><meta property="og:url" content="https://iszw.github.io/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"><meta property="og:site_name" content="iSzw_Blog"><meta property="og:description" content="Vue深入理解"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fwLR6I.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '2'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/custom.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/footer.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/buttons.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://iszw.github.io/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"><link rel="prev" title="Webpack性能优化" href="https://iszw.github.io/2019/07/20/Webpack%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><link rel="next" title="Git命令详解" href="https://iszw.github.io/2019/03/21/Git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://isuziwei.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"富強,民主,文明,和諧,自由,平等,公正,法治,愛國,敬業,誠信,友善","fontSize":"14px"},
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-center"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">164</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/playlist/"><i class="fa-fw fa fa-music"></i><span> 歌单</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#组件化基础"><span class="toc-number">1.</span> <span class="toc-text">组件化基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vue响应式"><span class="toc-number">2.</span> <span class="toc-text">Vue响应式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Object-defineProperty-基本用法"><span class="toc-number">2.1.</span> <span class="toc-text">Object.defineProperty()基本用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#深度监听data变化"><span class="toc-number">2.2.</span> <span class="toc-text">深度监听data变化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-defineProperty-的缺陷"><span class="toc-number">2.2.1.</span> <span class="toc-text">Object.defineProperty()的缺陷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#虚拟DOM-Virture-DOM"><span class="toc-number">3.</span> <span class="toc-text">虚拟DOM(Virture DOM)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">3.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用JS模拟DOM结构"><span class="toc-number">3.2.</span> <span class="toc-text">用JS模拟DOM结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#diff算法"><span class="toc-number">4.</span> <span class="toc-text">diff算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#diff算法概述"><span class="toc-number">4.1.</span> <span class="toc-text">diff算法概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#树的diff算法时间复杂度为O-n-3"><span class="toc-number">4.1.1.</span> <span class="toc-text">树的diff算法时间复杂度为O(n^3):</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#🌟🌟🌟优化时间复杂度到O-n"><span class="toc-number">4.2.</span> <span class="toc-text">🌟🌟🌟优化时间复杂度到O(n)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snabbdom源码"><span class="toc-number">4.3.</span> <span class="toc-text">Snabbdom源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#patch-函数"><span class="toc-number">4.3.1.</span> <span class="toc-text">patch()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patchVnode-函数"><span class="toc-number">4.3.2.</span> <span class="toc-text">patchVnode()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updateChildren-函数"><span class="toc-number">4.3.3.</span> <span class="toc-text">updateChildren()函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模板编译"><span class="toc-number">5.</span> <span class="toc-text">模板编译</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#with语法"><span class="toc-number">5.1.</span> <span class="toc-text">with语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板编译具体实现"><span class="toc-number">5.2.</span> <span class="toc-text">模板编译具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vue组件中使用render代替template"><span class="toc-number">5.3.</span> <span class="toc-text">vue组件中使用render代替template</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#vue组件的渲染和更新"><span class="toc-number">6.</span> <span class="toc-text">vue组件的渲染和更新</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初次渲染过程"><span class="toc-number">6.1.</span> <span class="toc-text">初次渲染过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#执行render函数-会触发getter"><span class="toc-number">6.1.1.</span> <span class="toc-text">执行render函数 会触发getter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新过程"><span class="toc-number">6.2.</span> <span class="toc-text">更新过程</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fwLR6I.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">iSzw_Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/playlist/"><i class="fa-fw fa fa-music"></i><span> 歌单</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Vue深入理解</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2019-04-15 03:22:15"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-04-15</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/study/">study</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">2.8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 13 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="组件化基础"><a href="#组件化基础" class="headerlink" title="组件化基础"></a>组件化基础</h1><p>​    传统组件，只是静态渲染，更新还是要依赖于操作<code>DOM</code>，比如<code>JQuery</code>。而<code>Vue</code>的<code>MVVM</code>、<code>React</code>的<code>setState</code>都是<code>数据驱动视图的框架</code>。</p>
<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/f527UQ.jpg"  alt="f527UQ"></p>
<p>​    第一个<code>M（Model）</code>表示的是<code>Vue</code>组件中的<code>Data</code>部分，第二个<code>V（View）</code>表示的是<code>Vue</code>组件中的视图，也就是html模板，而<code>VM（ViewModel）</code>比较抽象，可以理解为<code>Vue</code>提供的能力，是<code>View</code>层和<code>Model</code>层连接的部分，具像化来说就是<code>Vue</code>的指令、方法等等。</p>
<h1 id="Vue响应式"><a href="#Vue响应式" class="headerlink" title="Vue响应式"></a>Vue响应式</h1><ul>
<li>组件data的数据一旦变化，立刻触发视图的更新</li>
<li>实现数据驱动视图的第一步</li>
<li>核心API: Object.defineProperty()</li>
</ul>
<h2 id="Object-defineProperty-基本用法"><a href="#Object-defineProperty-基本用法" class="headerlink" title="Object.defineProperty()基本用法"></a>Object.defineProperty()基本用法</h2><blockquote>
<p><strong>Object.defineProperty(obj, prop/key, descriptor)</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> name = <span class="string">'zhangsan'</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(data, <span class="string">'name'</span>, &#123;</span><br><span class="line">    <span class="keyword">get</span>: function() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'get'</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>: function(newVal) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'set'</span>)</span><br><span class="line">        name = newVal</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// test</span></span><br><span class="line"><span class="built_in">console</span>.log(data.name) <span class="comment">// get zhangsan</span></span><br><span class="line">data.name = <span class="string">'lisi'</span> <span class="comment">// set</span></span><br></pre></td></tr></table></figure>

<h2 id="深度监听data变化"><a href="#深度监听data变化" class="headerlink" title="深度监听data变化"></a>深度监听data变化</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 触发更新视图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateView</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'视图更新'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 🌟🌟🌟重新定义数组原型</span></span><br><span class="line"><span class="keyword">const</span> oldArrayProperty = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="comment">// 🌟🌟🌟创建新对象，原型指向 oldArrayProperty ，再扩展新的方法（触发视图更新）不会影响原型</span></span><br><span class="line"><span class="keyword">const</span> arrProto = <span class="built_in">Object</span>.create(oldArrayProperty);</span><br><span class="line">[<span class="string">'push'</span>, <span class="string">'pop'</span>, <span class="string">'shift'</span>, <span class="string">'unshift'</span>, <span class="string">'splice'</span>].forEach(<span class="function"><span class="params">methodName</span> =&gt;</span> &#123;</span><br><span class="line">    arrProto[methodName] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        updateView() <span class="comment">// 触发视图更新</span></span><br><span class="line">        oldArrayProperty[methodName].call(<span class="keyword">this</span>, ...arguments)</span><br><span class="line">        <span class="comment">// Array.prototype.push.call(this, ...arguments)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新定义属性，监听起来</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">target, key, value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ⭐⭐⭐深度监听</span></span><br><span class="line">    observer(value)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心 API</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">set</span>(newValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">                <span class="comment">// 深度监听</span></span><br><span class="line">                observer(newValue)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置新值</span></span><br><span class="line">                <span class="comment">// 注意，value 一直在闭包中，此处设置完之后，再 get 时也是会获取最新的值</span></span><br><span class="line">                value = newValue</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 触发更新视图</span></span><br><span class="line">                updateView()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听对象属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observer</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 不是对象或数组 就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">'object'</span> || target === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> target</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 污染全局的 Array 原型，不可取</span></span><br><span class="line">    <span class="comment">// Array.prototype.push = function () &#123;</span></span><br><span class="line">    <span class="comment">//     updateView()</span></span><br><span class="line">    <span class="comment">//     ...</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果target是数组，那么将target的原型复制成重写过的数组原型</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(target)) &#123;</span><br><span class="line">        target.__proto__ = arrProto</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新定义各个属性（for in 也可以遍历数组）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> target) &#123;</span><br><span class="line">        defineReactive(target, key, target[key])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备数据</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    name: <span class="string">'zhangsan'</span>,</span><br><span class="line">    age: <span class="number">20</span>,</span><br><span class="line">    info: &#123;</span><br><span class="line">        address: <span class="string">'北京'</span> <span class="comment">// 需要深度监听</span></span><br><span class="line">    &#125;,</span><br><span class="line">    nums: [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听数据</span></span><br><span class="line">observer(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line">data.name = <span class="string">'lisi'</span></span><br><span class="line">data.age = <span class="number">21</span></span><br><span class="line"><span class="comment">// console.log('age', data.age)</span></span><br><span class="line"></span><br><span class="line">data.x = <span class="string">'100'</span> <span class="comment">// 新增属性，监听不到 —— 所以有 Vue.set</span></span><br><span class="line"><span class="keyword">delete</span> data.name <span class="comment">// 删除属性，监听不到 —— 所以有 Vue.delete</span></span><br><span class="line"></span><br><span class="line">data.info.address = <span class="string">'上海'</span> <span class="comment">// 深度监听</span></span><br><span class="line"></span><br><span class="line">data.nums.push(<span class="number">4</span>) <span class="comment">// 监听数组</span></span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/ApRqGd.png"  alt="ApRqGd"></p>
<h3 id="Object-defineProperty-的缺陷"><a href="#Object-defineProperty-的缺陷" class="headerlink" title="Object.defineProperty()的缺陷"></a>Object.defineProperty()的缺陷</h3><ul>
<li>深度监听时需要递归到底，一次性计算量大</li>
<li>无法监听新增属性/删除属性（Vue.set / Vue.delete）</li>
<li>无法原生监听数组，需要特殊处理</li>
</ul>
<h1 id="虚拟DOM-Virture-DOM"><a href="#虚拟DOM-Virture-DOM" class="headerlink" title="虚拟DOM(Virture DOM)"></a>虚拟DOM(Virture DOM)</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>​    <code>DOM</code>操作既耗时也耗费性能，而<code>JS</code>的执行是比较快的。以前用<code>jQuery</code>，可以自行控制<code>DOM</code>操作的时机，手动调整。而<code>Vue</code>和<code>React</code>都是数据驱动视图，如何有效控制<code>DOM</code>操作？当代<code>web</code>页面的复杂度日益提升，有了一定的复杂度，想减少计算次数比较难，那么能不能把计算，更多地转移为<code>JS</code>计算。解决方案就是<code>vdom</code>。用<code>JS</code>来模拟<code>DOM</code>结构，计算出最小的变更，再来操作<code>DOM</code>。</p>
<h2 id="用JS模拟DOM结构"><a href="#用JS模拟DOM结构" class="headerlink" title="用JS模拟DOM结构"></a>用JS模拟DOM结构</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>vdom<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">style</span>=<span class="string">"font-size: 20px;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>a<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 🌟🌟🌟三要素</span></span><br><span class="line"><span class="comment"> * tag/el/sel: 标签或者选择器</span></span><br><span class="line"><span class="comment"> * props: 属性、样式、事件</span></span><br><span class="line"><span class="comment"> * children: 子元素/子节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#123;</span><br><span class="line">    tag: <span class="string">'div'</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">        className: <span class="string">'container'</span>,</span><br><span class="line">        id: <span class="string">'div1'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    children: [</span><br><span class="line">        &#123;</span><br><span class="line">            tag: <span class="string">'p'</span>,</span><br><span class="line">            children: <span class="string">'vdom'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            tag: <span class="string">'ul'</span>,</span><br><span class="line">            props: &#123;</span><br><span class="line">                style: <span class="string">'font-size: 20px;'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            children: [</span><br><span class="line">                &#123;</span><br><span class="line">                    tag: <span class="string">'li'</span>,</span><br><span class="line">                    children: <span class="string">'a'</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="diff算法"><a href="#diff算法" class="headerlink" title="diff算法"></a>diff算法</h1><h2 id="diff算法概述"><a href="#diff算法概述" class="headerlink" title="diff算法概述"></a>diff算法概述</h2><ul>
<li><code>diff</code>即对比，是一个广泛的概念，如<code>linux</code> 的<code>diff</code>命令、<code>git diff</code>等</li>
<li>两个<code>js</code>对象也可以做<code>diff</code>，如 <a href="http://github.com/cujojs/jiff" target="_blank" rel="noopener">http://github.com/cujojs/jiff</a></li>
<li>两棵树做<code>diff</code>，如这里的 <code>vdom diff</code>。</li>
</ul>
<p>![image-20200714140541476](/Users/su/Library/Application Support/typora-user-images/image-20200714140541476.png)</p>
<h3 id="树的diff算法时间复杂度为O-n-3"><a href="#树的diff算法时间复杂度为O-n-3" class="headerlink" title="树的diff算法时间复杂度为O(n^3):"></a>树的diff算法时间复杂度为O(n^3):</h3><ul>
<li>第一，遍历tree1；第二，遍历tree2；</li>
<li>第三，排序；</li>
<li>如果有1000个节点，那么就要计算10亿次，所以算法不可用</li>
</ul>
<h2 id="🌟🌟🌟优化时间复杂度到O-n"><a href="#🌟🌟🌟优化时间复杂度到O-n" class="headerlink" title="🌟🌟🌟优化时间复杂度到O(n)"></a>🌟🌟🌟优化时间复杂度到O(n)</h2><ul>
<li>只比较同一层级，不跨级比较；</li>
<li>tag不相同，则直接删掉重建，不再深度比较；</li>
<li>tag和key，两者都相同，则认为是相同节点，不再深度比较。</li>
</ul>
<h2 id="Snabbdom源码"><a href="#Snabbdom源码" class="headerlink" title="Snabbdom源码"></a>Snabbdom源码</h2><p><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener">snabbdom</a>是一个简洁强大的vdom库，易学易用。Vue也是参考它来实现的vdom和diff。</p>
<h3 id="patch-函数"><a href="#patch-函数" class="headerlink" title="patch()函数"></a>patch()函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i: number, <span class="attr">elm</span>: Node, <span class="attr">parent</span>: Node;</span><br><span class="line">    <span class="keyword">const</span> insertedVnodeQueue: VNodeQueue = [];</span><br><span class="line">    <span class="comment">// 执行 pre hook</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.pre.length; ++i) cbs.pre[i]();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一个参数不是 vnode</span></span><br><span class="line">    <span class="keyword">if</span> (!isVnode(oldVnode)) &#123;</span><br><span class="line">      <span class="comment">// 创建一个空的 vnode ，关联到这个 DOM 元素</span></span><br><span class="line">      oldVnode = emptyNodeAt(oldVnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相同的 vnode（key 和 sel 都相等）</span></span><br><span class="line">    <span class="keyword">if</span> (sameVnode(oldVnode, vnode)) &#123;</span><br><span class="line">      <span class="comment">// vnode 对比</span></span><br><span class="line">      patchVnode(oldVnode, vnode, insertedVnodeQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不同的 vnode ，直接删掉重建</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      elm = oldVnode.elm!;</span><br><span class="line">      parent = api.parentNode(elm);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 重建</span></span><br><span class="line">      createElm(vnode, insertedVnodeQueue);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">        api.insertBefore(parent, vnode.elm!, api.nextSibling(elm));</span><br><span class="line">        removeVnodes(parent, [oldVnode], <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; insertedVnodeQueue.length; ++i) &#123;</span><br><span class="line">      insertedVnodeQueue[i].data!.hook!.insert!(insertedVnodeQueue[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.post.length; ++i) cbs.post[i]();</span><br><span class="line">    <span class="keyword">return</span> vnode;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="patchVnode-函数"><a href="#patchVnode-函数" class="headerlink" title="patchVnode()函数"></a>patchVnode()函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 🌟🌟🌟 patchVnode过程</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">patchVnode</span> (<span class="params">oldVnode: VNode, vnode: VNode, insertedVnodeQueue: VNodeQueue</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 执行 prepatch hook</span></span><br><span class="line">    <span class="keyword">const</span> hook = vnode.data?.hook;</span><br><span class="line">    hook?.prepatch?.(oldVnode, vnode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 vnode.elem</span></span><br><span class="line">    <span class="keyword">const</span> elm = vnode.elm = oldVnode.elm!;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 旧 children</span></span><br><span class="line">    <span class="keyword">let</span> oldCh = oldVnode.children <span class="keyword">as</span> VNode[];</span><br><span class="line">    <span class="comment">// 新 children</span></span><br><span class="line">    <span class="keyword">let</span> ch = vnode.children <span class="keyword">as</span> VNode[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode === vnode) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// hook 相关</span></span><br><span class="line">    <span class="keyword">if</span> (vnode.data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode);</span><br><span class="line">      vnode.data.hook?.update?.(oldVnode, vnode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vnode.text === undefined （vnode.children 一般有值）</span></span><br><span class="line">    <span class="keyword">if</span> (isUndef(vnode.text)) &#123;</span><br><span class="line">      <span class="comment">// 新旧都有 children</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue);</span><br><span class="line">      <span class="comment">// 新 children 有，旧 children 无 （旧 text 有）</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(ch)) &#123;</span><br><span class="line">        <span class="comment">// 清空 text</span></span><br><span class="line">        <span class="keyword">if</span> (isDef(oldVnode.text)) api.setTextContent(elm, <span class="string">''</span>);</span><br><span class="line">        <span class="comment">// 添加 children</span></span><br><span class="line">        addVnodes(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.length - <span class="number">1</span>, insertedVnodeQueue);</span><br><span class="line">      <span class="comment">// 旧 child 有，新 child 无</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(oldCh)) &#123;</span><br><span class="line">        <span class="comment">// 移除 children</span></span><br><span class="line">        removeVnodes(elm, oldCh, <span class="number">0</span>, oldCh.length - <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// 旧 text 有</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(oldVnode.text)) &#123;</span><br><span class="line">        api.setTextContent(elm, <span class="string">''</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// else : vnode.text !== undefined （vnode.children 无值）</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.text !== vnode.text) &#123;</span><br><span class="line">      <span class="comment">// 移除旧 children</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(oldCh)) &#123;</span><br><span class="line">        removeVnodes(elm, oldCh, <span class="number">0</span>, oldCh.length - <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 设置新 text</span></span><br><span class="line">      api.setTextContent(elm, vnode.text!);</span><br><span class="line">    &#125;</span><br><span class="line">    hook?.postpatch?.(oldVnode, vnode);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateChildren-函数"><a href="#updateChildren-函数" class="headerlink" title="updateChildren()函数"></a>updateChildren()函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateChildren</span> (<span class="params">parentElm: Node,</span></span></span><br><span class="line"><span class="function"><span class="params">    oldCh: VNode[],</span></span></span><br><span class="line"><span class="function"><span class="params">    newCh: VNode[],</span></span></span><br><span class="line"><span class="function"><span class="params">    insertedVnodeQueue: VNodeQueue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> oldStartIdx = <span class="number">0</span>, newStartIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> oldEndIdx = oldCh.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">    <span class="keyword">let</span> newEndIdx = newCh.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> newEndVnode = newCh[newEndIdx];</span><br><span class="line">    <span class="keyword">let</span> oldKeyToIdx: KeyToIndexMap | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">let</span> idxInOld: number;</span><br><span class="line">    <span class="keyword">let</span> elmToMove: VNode;</span><br><span class="line">    <span class="keyword">let</span> before: any;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx]; <span class="comment">// Vnode might have been moved left</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        newStartVnode = newCh[++newStartIdx];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        newEndVnode = newCh[--newEndIdx];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开始和开始对比</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">        patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue);</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">        newStartVnode = newCh[++newStartIdx];</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 结束和结束对比</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">        patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue);</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">        newEndVnode = newCh[--newEndIdx];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开始和结束对比</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">        patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue);</span><br><span class="line">        api.insertBefore(parentElm, oldStartVnode.elm!, api.nextSibling(oldEndVnode.elm!));</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">        newEndVnode = newCh[--newEndIdx];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 结束和开始对比</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sameVnode(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">        patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue);</span><br><span class="line">        api.insertBefore(parentElm, oldEndVnode.elm!, oldStartVnode.elm!);</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">        newStartVnode = newCh[++newStartIdx];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 以上四个都未命中</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldKeyToIdx === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拿新节点 key ，能否对应上 oldCh 中的某个节点的 key</span></span><br><span class="line">        idxInOld = oldKeyToIdx[newStartVnode.key <span class="keyword">as</span> string];</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 没对应上</span></span><br><span class="line">        <span class="keyword">if</span> (isUndef(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">          api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm!);</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对应上了</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 对应上 key 的节点</span></span><br><span class="line">          elmToMove = oldCh[idxInOld];</span><br><span class="line"></span><br><span class="line">          <span class="comment">// sel 是否相等（sameVnode 的条件）</span></span><br><span class="line">          <span class="keyword">if</span> (elmToMove.sel !== newStartVnode.sel) &#123;</span><br><span class="line">            <span class="comment">// New element</span></span><br><span class="line">            api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm!);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// sel 相等，key 相等</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            patchVnode(elmToMove, newStartVnode, insertedVnodeQueue);</span><br><span class="line">            oldCh[idxInOld] = <span class="literal">undefined</span> <span class="keyword">as</span> any;</span><br><span class="line">            api.insertBefore(parentElm, elmToMove.elm!, oldStartVnode.elm!);</span><br><span class="line">          &#125;</span><br><span class="line">          newStartVnode = newCh[++newStartIdx];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx || newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">        before = newCh[newEndIdx + <span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].elm;</span><br><span class="line">        addVnodes(parentElm, before, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板编译"><a href="#模板编译" class="headerlink" title="模板编译"></a>模板编译</h1><p>​    模板是<code>Vue</code>开发中最常用的部分，它不是<code>html</code>，有指令、插值、JS表达式。能实现判断、循环。<code>html</code>只是标签语言，只有<code>JS</code>才能实现<u>顺序执行、判断、循环</u>（<strong><code>图灵完备的</code></strong>）。因此，模板一定是转换为某种<code>JS</code>代码，即编译模板。了解了模板渲染，就能知道“组件渲染和更新过程”。</p>
<ul>
<li>前置知识：<code>JS</code>的<code>with</code>语法</li>
<li><code>vue template complier</code> 将模板编译为<code>render</code>函数</li>
<li>模板编译为<code>render</code>函数，执行<code>render</code>函数生成<code>vnode</code>，基于<code>vnode</code>再去执行<code>patch</code>和<code>diff</code>。</li>
<li>使用<code>webpack</code>的<code>vue-loader</code>，会在开发环境下编译模板，即解析模板为<code>render</code>函数（重要）</li>
</ul>
<h2 id="with语法"><a href="#with语法" class="headerlink" title="with语法"></a>with语法</h2><p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/FX9vtl.png"  alt="FX9vtl"></p>
<ul>
<li>改变 <code>{}</code> 内自由变量的查找方式，即当作<code>obj</code>属性来查找</li>
<li>如果找不到匹配的<code>obj</code>属性，就会报错</li>
<li>🌟🌟🌟 <code>with</code>要慎用，它打破了作用域规则，易读性变差（基本上不推荐使用）</li>
</ul>
<h2 id="模板编译具体实现"><a href="#模板编译具体实现" class="headerlink" title="模板编译具体实现"></a>模板编译具体实现</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiler = <span class="built_in">require</span>(<span class="string">'vue-template-compiler'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插值</span></span><br><span class="line"><span class="keyword">const</span> template = <span class="string">`&lt;p&gt;&#123;&#123;message&#125;&#125;&lt;/p&gt;`</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('p',[_v(_s(message))])&#125;</span></span><br><span class="line"><span class="comment">// with(this)&#123;return createElement('p',[createTextVNode(toString(message))])&#125;</span></span><br><span class="line"><span class="comment">// _c == createElement == h</span></span><br><span class="line"><span class="comment">// h -&gt; vnode | createElement -&gt; vnode</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // 表达式</span></span><br><span class="line"><span class="comment">// const template = `&lt;p&gt;&#123;&#123;flag ? message : 'no message found'&#125;&#125;&lt;/p&gt;`</span></span><br><span class="line"><span class="comment">// // with(this)&#123;return _c('p',[_v(_s(flag ? message : 'no message found'))])&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // 属性和动态属性</span></span><br><span class="line"><span class="comment">// const template = `</span></span><br><span class="line"><span class="comment">//     &lt;div id="div1" class="container"&gt;</span></span><br><span class="line"><span class="comment">//         &lt;img :src="imgUrl"/&gt;</span></span><br><span class="line"><span class="comment">//     &lt;/div&gt;</span></span><br><span class="line"><span class="comment">// `</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('div',</span></span><br><span class="line"><span class="comment">//      &#123;staticClass:"container",attrs:&#123;"id":"div1"&#125;&#125;,</span></span><br><span class="line"><span class="comment">//      [</span></span><br><span class="line"><span class="comment">//          _c('img',&#123;attrs:&#123;"src":imgUrl&#125;&#125;)])&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // 条件</span></span><br><span class="line"><span class="comment">// const template = `</span></span><br><span class="line"><span class="comment">//     &lt;div&gt;</span></span><br><span class="line"><span class="comment">//         &lt;p v-if="flag === 'a'"&gt;A&lt;/p&gt;</span></span><br><span class="line"><span class="comment">//         &lt;p v-else&gt;B&lt;/p&gt;</span></span><br><span class="line"><span class="comment">//     &lt;/div&gt;</span></span><br><span class="line"><span class="comment">// `</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('div',[(flag === 'a')?_c('p',[_v("A")]):_c('p',[_v("B")])])&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环</span></span><br><span class="line"><span class="comment">// const template = `</span></span><br><span class="line"><span class="comment">//     &lt;ul&gt;</span></span><br><span class="line"><span class="comment">//         &lt;li v-for="item in list" :key="item.id"&gt;&#123;&#123;item.title&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">//     &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">// `</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('ul',_l((list),function(item)&#123;return _c('li',&#123;key:item.id&#125;,[_v(_s(item.title))])&#125;),0)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件</span></span><br><span class="line"><span class="comment">// const template = `</span></span><br><span class="line"><span class="comment">//     &lt;button @click="clickHandler"&gt;submit&lt;/button&gt;</span></span><br><span class="line"><span class="comment">// `</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('button',&#123;on:&#123;"click":clickHandler&#125;&#125;,[_v("submit")])&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// v-model</span></span><br><span class="line"><span class="comment">// const template = `&lt;input type="text" v-model="name"&gt;`</span></span><br><span class="line"><span class="comment">// 主要看 input 事件</span></span><br><span class="line"><span class="comment">// with(this)&#123;return _c('input',&#123;directives:[&#123;name:"model",rawName:"v-model",value:(name),expression:"name"&#125;],attrs:&#123;"type":"text"&#125;,domProps:&#123;"value":(name)&#125;,on:&#123;"input":function($event)&#123;if($event.target.composing)return;name=$event.target.value&#125;&#125;&#125;)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// render 函数</span></span><br><span class="line"><span class="comment">// 返回 vnode</span></span><br><span class="line"><span class="comment">// patch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译</span></span><br><span class="line"><span class="keyword">const</span> res = compiler.compile(template)</span><br><span class="line"><span class="built_in">console</span>.log(res.render)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 🌟🌟🌟 从 vue 源码中找到缩写函数的含义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">installRenderHelpers</span> (<span class="params">target</span>) </span>&#123;</span><br><span class="line">    target._c = createElement;</span><br><span class="line">    target._o = markOnce;</span><br><span class="line">    target._n = toNumber;</span><br><span class="line">    target._s = toString;</span><br><span class="line">    target._l = renderList;</span><br><span class="line">    target._t = renderSlot;</span><br><span class="line">    target._q = looseEqual;</span><br><span class="line">    target._i = looseIndexOf;</span><br><span class="line">    target._m = renderStatic;</span><br><span class="line">    target._f = resolveFilter;</span><br><span class="line">    target._k = checkKeyCodes;</span><br><span class="line">    target._b = bindObjectProps;</span><br><span class="line">    target._v = createTextVNode;</span><br><span class="line">    target._e = createEmptyVNode;</span><br><span class="line">    target._u = resolveScopedSlots;</span><br><span class="line">    target._g = bindObjectListeners;</span><br><span class="line">    target._d = bindDynamicKeys;</span><br><span class="line">    target._p = prependModifier;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="vue组件中使用render代替template"><a href="#vue组件中使用render代替template" class="headerlink" title="vue组件中使用render代替template"></a>vue组件中使用render代替template</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">'heading'</span>, &#123;</span><br><span class="line">    <span class="comment">// template: `xxx`,</span></span><br><span class="line">    render: <span class="function"><span class="keyword">function</span>(<span class="params">createElement</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createElement(</span><br><span class="line">            <span class="string">'h'</span> + <span class="keyword">this</span>.level, <span class="comment">// h1、h2等标题</span></span><br><span class="line">            [</span><br><span class="line">                createElement(<span class="string">'a'</span>, &#123;</span><br><span class="line">                    attrs: &#123;</span><br><span class="line">                        name: <span class="string">'headerId'</span>,</span><br><span class="line">                        href: <span class="string">'#'</span> + <span class="string">'headerId'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="string">'this is a tag'</span>)</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>在有些复杂情况中，不能用<code>template</code>，可以考虑用<code>render</code></li>
<li><code>React</code>一直都在用<code>render</code>（没有模板），和这里一样</li>
</ul>
<h1 id="vue组件的渲染和更新"><a href="#vue组件的渲染和更新" class="headerlink" title="vue组件的渲染和更新"></a>vue组件的渲染和更新</h1><p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/I4Rn1o.jpg"  alt="I4Rn1o"></p>
<h2 id="初次渲染过程"><a href="#初次渲染过程" class="headerlink" title="初次渲染过程"></a>初次渲染过程</h2><ol>
<li>解析模板为 render 函数（或在开发环境中已完成，vue-loader）</li>
<li>触发响应式，监听 data 属性 getter setter</li>
<li>执行 render 函数，生成vnode ， patch(elem, vnode)</li>
</ol>
<h3 id="执行render函数-会触发getter"><a href="#执行render函数-会触发getter" class="headerlink" title="执行render函数 会触发getter"></a>执行render函数 会触发getter</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;&#123; message &#125;&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">	data()	&#123;</span></span><br><span class="line"><span class="regexp">    return &#123;</span></span><br><span class="line"><span class="regexp">      message: 'hello',	/</span><span class="regexp">/ 会触发 get</span></span><br><span class="line"><span class="regexp">      city: 'hangzhou' /</span><span class="regexp">/ 不会触发 get 因为模板没有用到，即和视图没有关系</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h2><ol>
<li>修改 data，触发setter（此前在getter中已被监听）</li>
<li>重新执行 render 函数，生成 newVnode</li>
<li>patch(vnode, newVnode)</li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">suvan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://iszw.github.io/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/">https://iszw.github.io/2019/04/15/Vue%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://iszw.github.io" target="_blank">iSzw_Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/vue/">vue</a><a class="post-meta__tags" href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/">响应式</a><a class="post-meta__tags" href="/tags/mvvm/">mvvm</a><a class="post-meta__tags" href="/tags/vdom/">vdom</a><a class="post-meta__tags" href="/tags/diff/">diff</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/Prettier.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/payQRCode.png" alt="向我打赏两元"/><div class="post-qr-code__desc">向我打赏两元</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/07/20/Webpack%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fS1c6w.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Webpack性能优化</div></div></a></div><div class="next-post pull_right"><a href="/2019/03/21/Git%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fu0VMt.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Git命令详解</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/09/05/Vue开发中的几个小tips/" title="Vue开发中的几个小tips"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fHbVno.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-09-05</div><div class="relatedPosts_title">Vue开发中的几个小tips</div></div></a></div><div class="relatedPosts_item"><a href="/2018/03/14/Vue2.0搭建旅游网站开发笔记/" title="Vue2.0搭建旅游网站开发笔记"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/ZW1Rws.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-03-14</div><div class="relatedPosts_title">Vue2.0搭建旅游网站开发笔记</div></div></a></div><div class="relatedPosts_item"><a href="/2017/12/14/Vue:构建数据驱动的web界面的渐进式框架/" title="Vue:构建数据驱动的web界面的渐进式框架"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/IR0uv5.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2017-12-14</div><div class="relatedPosts_title">Vue:构建数据驱动的web界面的渐进式框架</div></div></a></div><div class="relatedPosts_item"><a href="/2017/09/21/Vue的基础知识/" title="Vue的基础知识"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/fHbVno.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2017-09-21</div><div class="relatedPosts_title">Vue的基础知识</div></div></a></div><div class="relatedPosts_item"><a href="/2017/12/10/基于Vue+Webpack打造todoApp应用/" title="基于Vue+Webpack打造todoApp应用"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/iszw/ImgHosting@master/uPic/93EiSR.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2017-12-10</div><div class="relatedPosts_title">基于Vue+Webpack打造todoApp应用</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: 'brdzyt5vvqHKSx1EeqP329Na-9Nh9j0Va',
  appKey: 'NuTaxQbs1RIE2eSA5cpcVq4F',
  placeholder: '記得留下你的昵稱和郵箱...可以快速收到回復',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'en',
  recordIP: true,
  serverURLs: ''
});</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By suvan</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/ClickShowText.js"></script><script src="https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
      pangu.spacingElementById('content-inner')
})</script><script src="/js/search/local-search.js"></script></body></html>